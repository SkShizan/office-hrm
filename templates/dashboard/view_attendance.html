{% extends 'base.html' %}

{% block content %}
<style>
    /* --- HEADER & NAVIGATION --- */
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
    }
    
    .month-navigator {
        background: white;
        padding: 8px 16px;
        border-radius: var(--radius-sm);
        box-shadow: var(--shadow-sm);
        display: flex;
        align-items: center;
        gap: 15px;
        font-family: 'Outfit', sans-serif;
        font-weight: 600;
        font-size: 1.1rem;
        border: 1px solid var(--c-beige);
    }
    .nav-arrow {
        color: var(--c-orange);
        padding: 5px 10px;
        border-radius: 4px;
        transition: background 0.2s;
    }
    .nav-arrow:hover { background: var(--c-beige); }

    /* --- STATS WIDGET --- */
    .stats-ribbon {
        background: white;
        border-radius: var(--radius-md);
        box-shadow: var(--shadow-card);
        padding: 20px;
        margin-bottom: 30px;
        display: grid;
        grid-template-columns: repeat(7, 1fr); /* Expanded for new stats */
        gap: 10px;
        border-top: 4px solid var(--c-charcoal);
    }

    .stat-item {
        text-align: center;
        position: relative;
    }
    
    .stat-item:not(:last-child)::after {
        content: "";
        position: absolute;
        right: -5px;
        top: 15%;
        height: 70%;
        width: 1px;
        background: #eee;
    }

    .stat-label {
        display: block;
        font-size: 0.65rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--c-text-muted);
        margin-bottom: 5px;
        font-weight: 700;
    }
    .stat-value {
        font-family: 'Outfit', sans-serif;
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--c-charcoal);
    }

    /* --- CALENDAR GRID --- */
    .calendar-wrapper {
        background: white;
        border-radius: var(--radius-md);
        box-shadow: var(--shadow-card);
        overflow: hidden;
        border: 1px solid rgba(0,0,0,0.05);
        margin-bottom: 40px;
    }

    .calendar-header {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        background: var(--c-charcoal);
        color: var(--c-cream);
        text-align: center;
        padding: 15px 0;
        font-family: 'Outfit', sans-serif;
        font-weight: 600;
        letter-spacing: 1px;
        text-transform: uppercase;
        font-size: 0.85rem;
    }

    .calendar-body {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        background: var(--c-beige);
        gap: 1px; 
    }

    .cal-cell {
        background: white;
        min-height: 150px;
        padding: 10px;
        position: relative;
        transition: background 0.2s;
        display: flex;
        flex-direction: column;
    }

    .cal-cell.empty { background: #FCFCFC; }
    .cal-cell:hover { background: #FFFEFA; }

    .cell-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
    }
    .date-num {
        font-family: 'Outfit', sans-serif;
        font-weight: 700;
        font-size: 1.1rem;
        color: var(--c-charcoal);
    }
    .day-name { font-size: 0.75rem; color: #999; }

    /* --- STATUS STYLING --- */
    .status-Present { border-left: 4px solid #2E7D32; background: linear-gradient(to right, #F1F8E9, white 40%); }
    .status-Absent  { border-left: 4px solid #D32F2F; background: linear-gradient(to right, #FFEBEE, white 40%); }
    .status-Leave   { border-left: 4px solid var(--c-orange); background: linear-gradient(to right, #FFF3E0, white 40%); }
    .status-WFH     { border-left: 4px solid #0288D1; background: linear-gradient(to right, #E1F5FE, white 40%); }
    .status-Holiday { background: #F3E5F5; opacity: 0.8; }
    
    /* NEW: Late Styles */
    .status-2nd\ Late { border-left: 4px solid #FBC02D; background: linear-gradient(to right, #FFFDE7, white 40%); }
    .status-3rd\ Late { border-left: 4px solid #C62828; background: linear-gradient(to right, #FFEBEE, white 40%); }

    .status-tag {
        font-size: 0.7rem;
        font-weight: 700;
        text-transform: uppercase;
        margin-bottom: 5px;
        display: inline-block;
        padding: 2px 4px;
        border-radius: 4px;
    }
    
    .tag-Present { color: #2E7D32; }
    .tag-Absent  { color: #D32F2F; }
    .tag-Leave   { color: var(--c-orange); }
    .tag-WFH     { color: #0288D1; }
    .tag-2nd\ Late { color: #F57F17; background: #FFF9C4; }
    .tag-3rd\ Late { color: #B71C1C; background: #FFCDD2; }

    /* Controls */
    .calendar-controls select, 
    .calendar-controls input[type="time"] {
        width: 100%;
        margin-top: 4px;
        font-size: 0.75rem;
        padding: 4px 6px;
        border: 1px solid #eee;
        border-radius: 4px;
        background: #f9f9f9;
        color: #555;
    }
    .calendar-controls select:focus,
    .calendar-controls input:focus {
        border-color: var(--c-orange);
        background: white;
    }
    
    .time-stamp {
        font-size: 0.75rem;
        color: var(--c-text-muted);
        background: #eee;
        padding: 2px 6px;
        border-radius: 4px;
        align-self: flex-start;
        margin-top: auto;
    }

    /* --- PAYROLL & SALARY SECTION --- */
    .salary-wrapper {
        background: white;
        border-radius: var(--radius-md);
        box-shadow: var(--shadow-card);
        overflow: hidden;
        border: 1px solid rgba(0,0,0,0.05);
    }

    .salary-header {
        background: var(--c-charcoal);
        color: var(--c-cream);
        padding: 15px 25px;
        font-family: 'Outfit', sans-serif;
        font-weight: 600;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .salary-body {
        display: grid;
        grid-template-columns: 1.2fr 0.8fr;
        gap: 0;
    }

    .salary-breakdown {
        padding: 30px;
    }

    .salary-settings {
        background: #fafafa;
        padding: 30px;
        border-left: 1px solid #eee;
    }

    .pay-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 12px;
        font-size: 0.95rem;
        color: var(--c-charcoal);
    }
    
    .pay-row.sub-text { font-size: 0.85rem; color: #999; margin-top: -8px; margin-bottom: 15px; }
    .pay-row.deduction { color: #D32F2F; }
    .pay-row.gross { font-weight: 700; border-top: 1px dashed #ddd; padding-top: 10px; margin-top: 10px; }
    
    .net-pay-box {
        background: #F1F8E9;
        border: 1px solid #C5E1A5;
        border-radius: var(--radius-sm);
        padding: 15px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 20px;
        color: #2E7D32;
    }
    .net-label { font-weight: 600; text-transform: uppercase; font-size: 0.9rem; }
    .net-amount { font-family: 'Outfit', sans-serif; font-size: 1.5rem; font-weight: 700; }

    /* Payroll Form Inputs */
    .form-group-pay { margin-bottom: 15px; }
    .form-group-pay label { display: block; font-size: 0.8rem; font-weight: 600; margin-bottom: 5px; color: #666; }
    .form-group-pay input {
        width: 100%; padding: 10px; border: 1px solid var(--c-beige); border-radius: 6px;
        font-family: 'Outfit', sans-serif; transition: all 0.2s;
    }
    .form-group-pay input:focus { border-color: var(--c-orange); outline: none; }
    
    .btn-save-pay {
        width: 100%; background: var(--c-charcoal); color: white; border: none; padding: 12px;
        border-radius: 6px; font-weight: 600; cursor: pointer; transition: background 0.2s;
    }
    .btn-save-pay:hover { background: black; }

    /* Empty State */
    .salary-empty {
        padding: 40px; text-align: center; color: #999;
    }

    @media (max-width: 900px) {
        .calendar-header, .calendar-body { overflow-x: auto; min-width: 800px; }
        .calendar-wrapper { overflow-x: auto; }
        .salary-body { grid-template-columns: 1fr; }
        .salary-settings { border-left: none; border-top: 1px solid #eee; }
        .stats-ribbon { grid-template-columns: repeat(4, 1fr); gap: 15px; }
    }
</style>

<div class="page-header">
    <div class="header-title">
        <h2 style="font-family: 'Outfit'; margin-bottom: 5px;">Attendance Record</h2>
        <span style="color: var(--c-text-muted);">{{ target_user.username }}</span>
    </div>

    <div class="month-navigator">
        <a href="?month={{ month|add:'-1' }}&year={{ year }}" class="nav-arrow">
            <i class="fa-solid fa-chevron-left"></i>
        </a>
        <span>{{ month_name }} {{ year }}</span>
        <a href="?month={{ month|add:'1' }}&year={{ year }}" class="nav-arrow">
            <i class="fa-solid fa-chevron-right"></i>
        </a>
    </div>
</div>

<div class="stats-ribbon">
    <div class="stat-item">
        <span class="stat-label">Total Days</span>
        <div class="stat-value">{{ stats.total_days }}</div>
    </div>
    <div class="stat-item">
        <span class="stat-label" style="color: #2E7D32;">Present</span>
        <div class="stat-value" style="color: #2E7D32;">{{ stats.present }}</div>
    </div>
    <div class="stat-item">
        <span class="stat-label" style="color: #F57F17;">2nd Late</span>
        <div class="stat-value" style="color: #F57F17;">{{ stats.late_2nd }}</div>
    </div>
    <div class="stat-item">
        <span class="stat-label" style="color: #C62828;">3rd Late</span>
        <div class="stat-value" style="color: #C62828;">{{ stats.late_3rd }}</div>
    </div>
    <div class="stat-item">
        <span class="stat-label" style="color: #D32F2F;">Absent</span>
        <div class="stat-value" style="color: #D32F2F;">{{ stats.absent }}</div>
    </div>
    <div class="stat-item">
        <span class="stat-label" style="color: var(--c-orange);">Leaves</span>
        <div class="stat-value" style="color: var(--c-orange);">{{ stats.leave }}</div>
    </div>
</div>

<div class="calendar-wrapper">
    <div class="calendar-header">
        <div>Sun</div>
        <div>Mon</div>
        <div>Tue</div>
        <div>Wed</div>
        <div>Thu</div>
        <div>Fri</div>
        <div>Sat</div>
    </div>

    <div class="calendar-body">
        {% for day in month_days %}
            {% if day is None %}
                <div class="cal-cell empty"></div> 
            {% else %}
                <div class="cal-cell status-{{ day.status }}">
                    <div class="cell-header">
                        <span class="date-num">{{ day.day }}</span>
                        <span class="day-name">{{ day.day_name|slice:":3" }}</span>
                    </div>

                    {% if is_manager %}
                        <form method="POST" class="calendar-controls">
                            {% csrf_token %}
                            <input type="hidden" name="date" value="{{ day.date|date:'Y-m-d' }}">
                            
                            <select name="status" onchange="this.form.submit()">
                                <option value="Present" {% if day.status == 'Present' %}selected{% endif %}>Present</option>
                                <option value="2nd Late" {% if day.status == '2nd Late' %}selected{% endif %}>Mark 2nd Late (50% Cut)</option>
                                <option value="3rd Late" {% if day.status == '3rd Late' %}selected{% endif %}>Mark 3rd Late (100% Cut)</option>
                                <option value="Absent" {% if day.status == 'Absent' %}selected{% endif %}>Absent</option>
                                <option value="WFH" {% if day.status == 'WFH' %}selected{% endif %}>WFH</option>
                                <option value="Leave" {% if day.status == 'Leave' %}selected{% endif %}>Leave</option>
                                <option value="Holiday" {% if day.status == 'Holiday' %}selected{% endif %}>Holiday</option>
                            </select>

                            <input type="time" name="login_time" 
                                   value="{{ day.login_time|time:'H:i' }}" 
                                   onblur="this.form.submit()">
                        </form>
                    {% else %}
                        {% if day.status != 'None' %}
                            <div class="status-tag tag-{{ day.status }}">{{ day.status }}</div>
                        {% endif %}

                        {% if day.login_time %}
                            <div class="time-stamp">
                                <i class="fa-regular fa-clock"></i> {{ day.login_time|time:"H:i" }}
                            </div>
                        {% endif %}
                    {% endif %}
                </div>
            {% endif %}
        {% endfor %}
    </div>
</div>

<div class="salary-wrapper">
    <div class="salary-header">
        <span><i class="fa-solid fa-file-invoice-dollar"></i> Estimated Payroll</span>
        {% if salary_data %}
            <span style="opacity: 0.8; font-weight: 400; font-size: 0.9rem;">Based on {{ month_name }} Attendance</span>
        {% endif %}
    </div>

    {% if salary_data %}
    <div class="salary-body">
        
        <div class="salary-breakdown">
            <h4 style="font-family: 'Outfit'; margin-bottom: 20px; color: var(--c-charcoal);">Salary Slip Estimate</h4>
            
            <div class="pay-row">
                <span>Base Monthly Salary</span>
                <strong>₹{{ salary_data.base_salary }}</strong>
            </div>
            <div class="pay-row sub-text">
                Calculated Daily Rate: ₹{{ salary_data.per_day }}
            </div>

            <div class="pay-row deduction">
                <span>Absent + 3rd Late ({{ salary_data.absent_days|add:salary_data.late_3rd_days }} Days)</span>
                <span>- ₹{{ salary_data.full_day_deduction }}</span>
            </div>

            <div class="pay-row deduction">
                <span>2nd Late Deductions ({{ salary_data.late_2nd_days }} Days @ 50%)</span>
                <span>- ₹{{ salary_data.half_day_deduction }}</span>
            </div>

            <div class="pay-row gross">
                <span>Gross Salary</span>
                <span>₹{{ salary_data.gross_salary }}</span>
            </div>

            <div class="pay-row deduction" style="margin-top: 10px;">
                <span>ESI Deduction ({{ salary_data.esi_pct }}%)</span>
                <span>- ₹{{ salary_data.esi_amount }}</span>
            </div>

            <div class="pay-row deduction">
                <span>Professional Tax</span>
                <span>- ₹{{ salary_data.p_tax }}</span>
            </div>

            <div class="net-pay-box">
                <span class="net-label">Net Payable</span>
                <span class="net-amount">₹{{ salary_data.net_salary }}</span>
            </div>
            
            <p style="font-size: 0.75rem; color: #999; margin-top: 15px;">
                * "3rd Late" marks automatically remove the previous "2nd Late".
            </p>
        </div>

        {% if is_manager %}
            <div class="salary-settings">
                <h4 style="font-family: 'Outfit'; margin-bottom: 20px; color: var(--c-charcoal);">Payroll Configuration</h4>
                
                <form method="POST">
                    {% csrf_token %}
                    <input type="hidden" name="update_salary" value="true">
                    
                    <div class="form-group-pay">
                        <label>Monthly Base Salary (₹)</label>
                        <input type="number" step="0.01" name="monthly_salary" value="{{ target_user.monthly_salary }}" required>
                    </div>

                    <div class="form-group-pay">
                        <label>ESI Percentage (%)</label>
                        <input type="number" step="0.01" name="esi_percentage" value="{{ target_user.esi_percentage }}" required>
                    </div>

                    <div class="form-group-pay">
                        <label>Professional Tax (Fixed ₹)</label>
                        <input type="number" step="0.01" name="professional_tax" value="{{ target_user.professional_tax }}" required>
                    </div>

                    <button type="submit" class="btn-save-pay">
                        <i class="fa-solid fa-check"></i> Update Payroll
                    </button>
                </form>
            </div>
        {% else %}
            <div class="salary-settings" style="display: flex; align-items: center; justify-content: center; text-align: center;">
                <div style="opacity: 0.5;">
                    <i class="fa-solid fa-shield-halved" style="font-size: 2rem; margin-bottom: 10px;"></i>
                    <p>Payroll settings are managed by HR/Admin.</p>
                </div>
            </div>
        {% endif %}
        
    </div>
    {% else %}
        <div class="salary-empty">
            <i class="fa-solid fa-coins" style="font-size: 2.5rem; margin-bottom: 15px; opacity: 0.3;"></i>
            <h3>Salary Not Configured</h3>
            
            {% if is_manager %}
                <p style="margin-bottom: 20px;">Initialize payroll details to see the breakdown.</p>
                <form method="POST" style="max-width: 300px; margin: 0 auto;">
                    {% csrf_token %}
                    <input type="hidden" name="update_salary" value="true">
                    <div class="form-group-pay" style="text-align: left;">
                        <label>Enter Base Salary</label>
                        <input type="number" name="monthly_salary" placeholder="e.g. 25000" required>
                    </div>
                    <button type="submit" class="btn-save-pay">Initialize</button>
                </form>
            {% else %}
                <p>Please contact HR to update your payroll details.</p>
            {% endif %}
        </div>
    {% endif %}
</div>

{% endblock %}