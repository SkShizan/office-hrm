{% extends 'base.html' %}

{% block content %}
<style>
    /* --- GRID LAYOUT --- */
    .dashboard-container {
        display: grid;
        grid-template-columns: 350px 1fr; /* Fixed Sidebar + Fluid Content */
        gap: 30px;
        align-items: start;
    }

    /* --- SEARCH CARD (UPDATED) --- */
    .search-card {
        background: var(--c-charcoal);
        padding: 25px;
        border-radius: var(--radius-md);
        color: white;
        margin-bottom: 25px;
        box-shadow: var(--shadow-card);
    }
    .search-row {
        display: flex;
        gap: 15px;
        margin-top: 15px;
    }
    .search-group {
        flex: 1;
    }
    .search-label {
        display: block;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #bbb;
        margin-bottom: 5px;
        font-weight: 600;
    }
    .search-select {
        width: 100%;
        padding: 10px;
        border-radius: 6px;
        border: 1px solid #444;
        background: #333;
        color: white;
        font-size: 0.95rem;
    }
    .search-select:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    .btn-go {
        background: var(--c-orange);
        color: white;
        border: none;
        padding: 0 25px;
        border-radius: 6px;
        font-weight: bold;
        cursor: pointer;
        align-self: flex-end; /* Aligns with input boxes */
        height: 42px; /* Matches input height */
    }
    .btn-go:hover { background: var(--c-orange-hover); }

    /* --- WELCOME HEADER --- */
    .welcome-banner { margin-bottom: 30px; display: flex; justify-content: space-between; align-items: flex-end; border-bottom: 1px solid var(--c-beige); padding-bottom: 20px; }
    .welcome-text h2 { font-family: 'Outfit'; font-size: 2rem; color: var(--c-charcoal); margin-bottom: 5px; }
    .welcome-text p { color: var(--c-text-muted); }
    .date-badge { background: white; border: 1px solid #eee; padding: 8px 15px; border-radius: 8px; font-weight: 600; color: #555; display: flex; align-items: center; gap: 8px; }

    /* --- PROFILE CARD --- */
    .profile-card { background: white; border-radius: var(--radius-md); box-shadow: var(--shadow-card); overflow: hidden; position: relative; }
    .profile-banner-bg { height: 80px; background: linear-gradient(135deg, var(--c-charcoal) 0%, #444 100%); }
    .profile-body { padding: 0 25px 25px 25px; text-align: center; margin-top: -40px; }
    .avatar-circle { width: 90px; height: 90px; background: var(--c-orange); color: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 2.5rem; font-family: 'Outfit'; font-weight: 700; border: 4px solid white; margin: 0 auto 15px auto; }
    .user-name { font-size: 1.4rem; font-weight: 700; color: var(--c-charcoal); margin-bottom: 4px; }
    .user-designation { font-size: 0.95rem; color: #777; margin-bottom: 15px; display: block; }
    .badges-row { display: flex; justify-content: center; gap: 8px; margin-bottom: 25px; flex-wrap: wrap; }
    .pill { font-size: 0.75rem; padding: 4px 10px; border-radius: 12px; font-weight: 600; }
    .pill-role { background: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
    .pill-section { background: #e6f7ff; color: #0050b3; border: 1px solid #bae7ff; }
    .pill-team { background: #f6ffed; color: #389e0d; border: 1px solid #b7eb8f; }
    .info-list { text-align: left; border-top: 1px solid #f0f0f0; padding-top: 20px; }
    .info-item { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 0.9rem; }
    
    /* --- STATS & ACTIONS --- */
    .stats-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
    .stat-card { background: white; padding: 20px; border-radius: var(--radius-md); box-shadow: var(--shadow-card); display: flex; align-items: center; gap: 20px; }
    .stat-icon-box { width: 50px; height: 50px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; }
    .stat-casual { background: #e6f7ff; color: #007bff; }
    .stat-sick { background: #fff0f6; color: #d63384; }
    .stat-data h3 { font-size: 1.8rem; margin: 0; color: var(--c-charcoal); line-height: 1; }
    
    .action-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; }
    .action-card { background: white; padding: 25px; border-radius: var(--radius-md); box-shadow: var(--shadow-card); text-decoration: none; color: inherit; display: block; transition: 0.2s; }
    .action-card:hover { transform: translateY(-5px); }
    .action-header { display: flex; justify-content: space-between; margin-bottom: 15px; }
    .act-icon { font-size: 1.5rem; color: var(--c-orange); }

    /* --- TABLES --- */
    .team-manage-card { background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.06); overflow: hidden; margin-top: 20px; border: 1px solid #eee; }
    .team-table { width: 100%; border-collapse: collapse; }
    .team-table th { text-align: left; padding: 15px 20px; font-size: 0.85rem; color: #888; background: #f8f9fa; border-bottom: 1px solid #eee; }
    .team-table td { padding: 15px 20px; border-bottom: 1px solid #f9f9f9; vertical-align: middle; }
    .status-badge { font-size: 0.75rem; padding: 4px 8px; border-radius: 12px; font-weight: 600; }
    .st-Pending { background: #fff3cd; color: #856404; }
    .st-Completed { background: #d4edda; color: #155724; }
    
    /* BUTTONS FOR TEAM ACTION */
    .btn-view-cal, .btn-view-track, .btn-view-quota { 
        display: inline-flex; align-items: center; gap: 5px; 
        padding: 6px 12px; border-radius: 6px; font-size: 0.85rem; 
        cursor: pointer; transition: 0.2s; margin-left: 3px;
    }
    
    .btn-view-cal { background: white; border: 1px solid #28a745; color: #28a745; }
    .btn-view-cal:hover { background: #28a745; color: white; }
    
    .btn-view-track { background: white; border: 1px solid #fd7e14; color: #fd7e14; }
    .btn-view-track:hover { background: #fd7e14; color: white; }

    .btn-view-quota { background: white; border: 1px solid #6c757d; color: #6c757d; }
    .btn-view-quota:hover { background: #6c757d; color: white; }

    @media (max-width: 900px) { .dashboard-container { grid-template-columns: 1fr; } .search-row { flex-direction: column; } }
</style>

<div class="welcome-banner">
    <div class="welcome-text">
        <h2>Hello, {{ user.username }}</h2>
        <p>Dashboard Overview for <strong>{{ user.company.name }}</strong></p>
    </div>
    <div class="date-badge">
        <i class="fa-regular fa-calendar"></i> {% now "l, jS F Y" %}
    </div>
</div>

<div class="dashboard-container">
    
    <div class="profile-card">
        <div class="profile-banner-bg"></div>
        <div class="profile-body">
            <div class="avatar-circle">{{ user.username|slice:":1"|upper }}</div>
            <div class="user-name">{{ user.username }}</div>
            <span class="user-designation">{{ user.designation }}</span>

            <div class="badges-row">
                <span class="pill pill-role">{{ user.role }}</span>
                {% if user.section %}
                    <span class="pill pill-section">{{ user.section }}</span>
                {% endif %}
                {% if user.team %}
                    <span class="pill pill-team">{{ user.team.name }}</span>
                {% endif %}
            </div>

            <div class="info-list">
                <div class="info-item">
                    <span style="color:#888;">Reports To</span>
                    <strong>{{ user.reports_to.username|default:"--" }}</strong>
                </div>
                <div class="info-item">
                    <span style="color:#888;">Status</span>
                    <span style="color: green;"><i class="fa-solid fa-circle-check"></i> Active</span>
                </div>
            </div>
        </div>
    </div>

    <div class="right-content">
        
        <div class="search-card">
            <h4 style="font-family:'Outfit'; margin:0;"><i class="fa-solid fa-users-viewfinder"></i> Assign Task & Find Colleague</h4>
            <p style="font-size:0.85rem; opacity:0.7; margin-bottom:15px; margin-top:5px;">Select a team, then choose a member to assign tasks or view activity.</p>
            
            <form id="colleagueForm" onsubmit="goToTrackSheet(event)" class="search-row">
                <div class="search-group">
                    <label class="search-label">1. Select Team</label>
                    <select id="teamSelect" class="search-select" onchange="filterEmployees()" required>
                        <option value="" disabled selected>-- Choose Team --</option>
                        {% for team in teams %}
                            <option value="{{ team.id }}">{{ team.name }}</option>
                        {% endfor %}
                        <option value="no_team">Other / No Team</option>
                    </select>
                </div>

                <div class="search-group">
                    <label class="search-label">2. Select Member</label>
                    <select id="colleagueSelect" class="search-select" disabled required>
                        <option value="" disabled selected>-- Waiting for Team --</option>
                        </select>
                </div>

                <button type="submit" class="btn-go">Go</button>
            </form>
        </div>

        <h4 style="margin-bottom: 15px; color: #555;">Your Leave Balance</h4>
        <div class="stats-row">
            <div class="stat-card">
                <div class="stat-icon-box stat-casual">
                    <i class="fa-solid fa-umbrella-beach"></i>
                </div>
                <div class="stat-data">
                    <h3>{{ user.leave_balance.casual_leave|default:"0" }}</h3>
                    <p>Casual Leave</p>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon-box stat-sick">
                    <i class="fa-solid fa-notes-medical"></i>
                </div>
                <div class="stat-data">
                    <h3>{{ user.leave_balance.sick_leave|default:"0" }}</h3>
                    <p>Sick Leave</p>
                </div>
            </div>
        </div>

        <h4 style="margin-bottom: 15px; margin-top: 10px; color: #555;">Quick Actions</h4>
        <div class="action-grid">
            
            <a href="{% url 'apply_leave' %}" class="action-card">
                <div class="action-header">
                    <div class="act-icon"><i class="fa-solid fa-paper-plane"></i></div>
                    <i class="fa-solid fa-arrow-right" style="color: #ddd;"></i>
                </div>
                <h4>Apply for Leave</h4>
                <p>Submit a new leave request for approval by your manager.</p>
            </a>

            <a href="{% url 'view_attendance' user.id %}" class="action-card">
                <div class="action-header">
                    <div class="act-icon" style="color: #28a745;"><i class="fa-solid fa-calendar-check"></i></div>
                    <i class="fa-solid fa-arrow-right" style="color: #ddd;"></i>
                </div>
                <h4>My Attendance</h4>
                <p>View your monthly attendance log and holiday calendar.</p>
            </a>
            
            <a href="{% url 'track_sheet' user.id %}" class="action-card">
                <div class="action-header">
                    <div class="act-icon" style="color: #fd7e14;"><i class="fa-solid fa-list-check"></i></div>
                    <i class="fa-solid fa-arrow-right" style="color: #ddd;"></i>
                </div>
                <h4>My Track Sheet</h4>
                <p>Log your daily work and view tasks assigned to you.</p>
            </a>

            {% if user.role == 'Manager' or user.role == 'TL' %}
                <a href="{% url 'leave_requests_list' %}" class="action-card" style="border-left: 4px solid #17a2b8;">
                    <div class="action-header">
                        <div class="act-icon" style="color: #17a2b8;"><i class="fa-solid fa-list-check"></i></div>
                        <i class="fa-solid fa-arrow-right" style="color: #ddd;"></i>
                    </div>
                    <h4>Approvals Inbox</h4>
                    <p>You have pending requests from your team members.</p>
                </a>
            {% endif %}
        </div>

        {% if tasks_i_assigned %}
        <h4 style="margin-top:40px; color:#555;"><i class="fa-solid fa-share-from-square"></i> Tasks You Assigned (Outbox)</h4>
        <div class="team-manage-card">
            <table class="team-table">
                <thead>
                    <tr>
                        <th>Assigned To</th>
                        <th>Date</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for task in tasks_i_assigned %}
                    <tr>
                        <td>
                            <strong>{{ task.user.username }}</strong><br>
                            <span style="font-size:0.75rem; color:#888;">{{ task.user.team.name|default:"No Team" }}</span>
                        </td>
                        <td>{{ task.date }}</td>
                        <td>
                            <span class="status-badge st-{{ task.status|cut:' ' }}">{{ task.status }}</span>
                        </td>
                        <td>
                            <a href="{% url 'track_sheet' task.user.id %}?year={{ task.date.year }}&month={{ task.date.month }}" style="color:#007bff; font-size:0.85rem;">View</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}

        {% if my_team_members %}
            <h4 style="margin-bottom: 15px; margin-top: 40px; color: #555;">My Team Management</h4>
            
            <div class="team-manage-card">
                <table class="team-table">
                    <thead>
                        <tr>
                            <th>Employee</th>
                            <th>Role</th>
                            <th style="text-align: right;">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for member in my_team_members %}
                            <tr>
                                <td>
                                    <div style="font-weight: 600; color: #333;">{{ member.username }}</div>
                                    <div style="font-size: 0.8rem; color: #999;">{{ member.designation }}</div>
                                </td>
                                <td>
                                    <span class="pill pill-role">
                                        {{ member.role }}
                                    </span>
                                </td>
                                <td style="text-align: right;">
                                    <a href="{% url 'view_attendance' member.id %}" style="text-decoration:none;" title="Calendar">
                                        <button class="btn-view-cal"><i class="fa-solid fa-calendar"></i></button>
                                    </a>
                                    
                                    <a href="{% url 'track_sheet' member.id %}" style="text-decoration:none;" title="Track Sheet">
                                        <button class="btn-view-track"><i class="fa-solid fa-list-check"></i></button>
                                    </a>

                                    <a href="{% url 'manage_quota' member.id %}" style="text-decoration:none;" title="Manage Quota">
                                        <button class="btn-view-quota"><i class="fa-solid fa-sliders"></i></button>
                                    </a>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% endif %}

    </div> 
</div> 

<script>
    // 1. Prepare Employee Data from Django
    const employees = [
        {% for colleague in all_colleagues %}
            {
                id: "{{ colleague.id }}",
                name: "{{ colleague.username }}",
                designation: "{{ colleague.designation }}",
                teamId: "{% if colleague.team %}{{ colleague.team.id }}{% else %}no_team{% endif %}"
            },
        {% endfor %}
    ];

    // 2. Filter Function
    function filterEmployees() {
        const teamSelect = document.getElementById('teamSelect');
        const empSelect = document.getElementById('colleagueSelect');
        const selectedTeamId = teamSelect.value;

        // Clear previous options
        empSelect.innerHTML = '<option value="" disabled selected>-- Select Member --</option>';
        empSelect.disabled = false;

        // Filter Array
        const filtered = employees.filter(emp => emp.teamId === selectedTeamId);

        if (filtered.length > 0) {
            filtered.forEach(emp => {
                const option = document.createElement('option');
                option.value = emp.id;
                option.textContent = `${emp.name} - ${emp.designation}`;
                empSelect.appendChild(option);
            });
        } else {
            const option = document.createElement('option');
            option.textContent = "No members found in this team";
            option.disabled = true;
            empSelect.appendChild(option);
        }
    }

    // 3. Go to Track Sheet
    function goToTrackSheet(e) {
        e.preventDefault();
        const userId = document.getElementById('colleagueSelect').value;
        if (userId) {
            window.location.href = "/track-sheet/" + userId + "/";
        }
    }
</script>
{% endblock %}